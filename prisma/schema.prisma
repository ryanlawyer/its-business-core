// ITS Business System - Core Edition
// Simplified schema for SMB (1-250 employees)
// SQLite for simplicity and NAS deployment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("SQLITE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model Role {
  id          String  @id @default(uuid())
  name        String  @unique // e.g., "Administrator", "Manager", "User"
  code        String  @unique // e.g., "ADMIN", "MANAGER", "USER"
  description String?
  isSystem    Boolean @default(false) // System roles cannot be deleted
  isActive    Boolean @default(true)

  // Permissions (JSON stored as string in SQLite)
  permissions String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]

  @@index([code])
  @@map("roles")
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String? // Optional for EntraID users
  name     String

  // EntraID fields (for future authentication)
  entraIdObjectId String? @unique
  authProvider    String  @default("local") // "local" | "entraId"

  // Role assignment
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  // Optional department assignment
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  timeclockEntries     TimeclockEntry[]
  purchaseOrders       PurchaseOrder[]
  auditLogs            AuditLog[] // Logs created by this user
  budgetAmendments     BudgetAmendment[]
  closedFiscalYears    FiscalYear[]

  // Receipt management relations
  receipts                 Receipt[]
  tags                     Tag[]
  merchantCategoryMappings MerchantCategoryMapping[]
  bankStatements           BankStatement[]

  // Manager assignment relations
  managerAssignments       ManagerAssignment[]

  // Export template relations
  exportTemplates          ExportTemplate[]

  @@index([email])
  @@index([roleId])
  @@index([departmentId])
  @@index([entraIdObjectId])
  @@map("users")
}

// ============================================
// ORGANIZATIONAL STRUCTURE
// ============================================

model Department {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  // Hierarchy support (for future use)
  parentId String?
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Department[] @relation("DepartmentHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  budgetItems           BudgetItem[]
  budgetTargets         DepartmentBudgetTarget[]
  purchaseOrders        PurchaseOrder[]
  managerAssignments    ManagerAssignment[]

  @@index([parentId])
  @@map("departments")
}

// ============================================
// BUDGET MANAGEMENT
// ============================================

model BudgetCategory {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?

  // Hierarchy support
  parentId String?
  parent   BudgetCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children BudgetCategory[] @relation("CategoryHierarchy")

  // GL Integration (for future QuickBooks/Xero)
  glAccountCode String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  budgetItems BudgetItem[]

  // Receipt management relations
  receipts                 Receipt[]
  receiptLineItems         ReceiptLineItem[]
  merchantCategoryMappings MerchantCategoryMapping[]

  @@index([parentId])
  @@map("budget_categories")
}

model BudgetItem {
  id           String  @id @default(uuid())
  code         String  @unique
  description  String
  budgetAmount Float   @default(0) // Total budget for this line item

  // Optional department
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // NEW: Category relationship
  categoryId String?
  category   BudgetCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Fiscal year (simple integer: 2025, 2026, etc.)
  fiscalYear Int @default(2025)

  // NEW: Accrual settings
  accrualType String @default("ANNUAL") // "ANNUAL", "MONTHLY", "QUARTERLY"

  // NEW: GL Integration
  glAccountCode String?

  // NEW: Stored values for budget tracking (updated by app logic)
  encumbered  Float @default(0) // Sum of APPROVED PO line items
  actualSpent Float @default(0) // Sum of COMPLETED PO line items

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  poLineItems      POLineItem[]
  budgetAmendments BudgetAmendment[]

  @@index([code])
  @@index([fiscalYear])
  @@index([departmentId])
  @@index([categoryId])
  @@map("budget_items")
}

model BudgetAmendment {
  id           String     @id @default(uuid())
  budgetItemId String
  budgetItem   BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  type   String // "INCREASE", "DECREASE", "TRANSFER_IN", "TRANSFER_OUT"
  amount Float
  reason String

  // For transfers: link related amendments
  relatedAmendmentId String?
  relatedAmendment   BudgetAmendment?  @relation("TransferLink", fields: [relatedAmendmentId], references: [id], onDelete: SetNull)
  relatedTo          BudgetAmendment[] @relation("TransferLink")

  // Transfer source/destination
  fromBudgetItemId String?
  toBudgetItemId   String?

  // Tracking
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  fiscalYear Int

  // Prior budget amount (for audit trail)
  previousAmount Float
  newAmount      Float

  createdAt DateTime @default(now())

  @@index([budgetItemId])
  @@index([createdById])
  @@index([fiscalYear])
  @@index([createdAt])
  @@map("budget_amendments")
}

model FiscalYear {
  id        String   @id @default(uuid())
  year      Int      @unique
  startDate DateTime
  endDate   DateTime

  status String @default("OPEN") // "OPEN", "SOFT_CLOSED", "HARD_CLOSED"

  closedById String?
  closedBy   User?    @relation(fields: [closedById], references: [id], onDelete: SetNull)
  closedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year])
  @@index([status])
  @@map("fiscal_years")
}

model DepartmentBudgetTarget {
  id           String     @id @default(uuid())
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  fiscalYear   Int
  targetAmount Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, fiscalYear])
  @@index([fiscalYear])
  @@map("department_budget_targets")
}

// ============================================
// VENDOR MANAGEMENT
// ============================================

model Vendor {
  id           String  @id @default(uuid())
  vendorNumber String  @unique
  name         String

  // Contact info
  phone   String?
  email   String?
  address String?
  city    String?
  state   String?
  zipCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  purchaseOrders PurchaseOrder[]
  receipts       Receipt[]

  @@index([vendorNumber])
  @@index([name])
  @@map("vendors")
}

// ============================================
// PURCHASE ORDER SYSTEM
// ============================================

enum POStatus {
  DRAFT             // Being created, not submitted
  PENDING_APPROVAL  // Submitted, waiting for manager approval
  APPROVED          // Approved, ready to send to vendor
  REJECTED          // Rejected by approver, can be revised and resubmitted
  COMPLETED         // Received and closed
  CANCELLED         // Cancelled (soft delete)
}

model PurchaseOrder {
  id       String   @id @default(uuid())
  poNumber String   @unique
  poDate   DateTime @default(now())

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Creator
  requestedById String
  requestedBy   User   @relation(fields: [requestedById], references: [id])

  // Department (links to creator's department)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Optional fields
  notes String?
  autoApprovalNote String?   // Reason auto-approval was skipped

  // Receipt attachment
  receiptFileName String?
  receiptFilePath String?

  // Workflow
  status POStatus @default(DRAFT)

  // Approval tracking
  approvedBy String?
  approvedAt DateTime?

  // Rejection tracking
  rejectedBy    String?
  rejectedAt    DateTime?
  rejectionNote String?

  // Void tracking
  voidedBy String?
  voidedAt DateTime?
  voidNote String?

  // Completion
  completedAt DateTime?

  // Totals (calculated from line items)
  totalAmount Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lineItems POLineItem[]
  documents Document[]
  receipts  Receipt[]
  bankTransactions BankTransaction[]

  @@index([poNumber])
  @@index([vendorId])
  @@index([requestedById])
  @@index([departmentId])
  @@index([status])
  @@index([poDate])
  @@map("purchase_orders")
}

model POLineItem {
  id          String @id @default(uuid())
  description String
  amount      Float

  // PO relationship
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Budget line item
  budgetItemId String
  budgetItem   BudgetItem @relation(fields: [budgetItemId], references: [id])

  @@index([purchaseOrderId])
  @@index([budgetItemId])
  @@map("po_line_items")
}

// ============================================
// DOCUMENT MANAGEMENT
// ============================================

model Document {
  id               String @id @default(uuid())
  filename         String
  originalFilename String
  filepath         String
  filesize         Int
  mimetype         String

  // Optional PO attachment
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  uploadedAt DateTime @default(now())

  @@index([purchaseOrderId])
  @@map("documents")
}

// ============================================
// TIMECLOCK SYSTEM
// ============================================

model TimeclockEntry {
  id       String    @id @default(uuid())
  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clockIn  DateTime
  clockOut DateTime?
  duration Int? // Duration in seconds (final, after rounding/break deduction)

  // Workflow processing fields
  rawDuration    Int?     // Original duration before rounding/break deduction
  breakDeducted  Int?     // Seconds deducted for break
  autoApproved   Boolean  @default(false)
  flagReason     String?  // "missed_punch" | "min_duration"

  // Approval workflow fields
  status       String  @default("pending") // "pending" | "submitted" | "approved" | "rejected"
  approvedBy   String?
  approvedAt   DateTime?
  rejectedNote String?
  isLocked     Boolean @default(false)

  // Audit trail fields
  lastEditedBy String?
  lastEditedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([clockIn])
  @@index([status])
  @@map("timeclock_entries")
}

// Pay period configuration (singleton - only one config per system)
model PayPeriodConfig {
  id             String    @id @default(uuid())
  type           String    @default("biweekly") // "weekly" | "biweekly" | "semimonthly" | "monthly"
  startDayOfWeek Int?      // 0-6 for weekly/biweekly (0=Sunday)
  startDate      DateTime? // Reference start date for biweekly

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pay_period_config")
}

// Overtime configuration (singleton - only one config per system)
model OvertimeConfig {
  id                 String  @id @default(uuid())
  dailyThreshold     Int?    // Minutes before daily OT (null = disabled)
  weeklyThreshold    Int?    // Minutes before weekly OT (null = disabled)
  alertBeforeDaily   Int?    // Minutes before daily threshold to alert
  alertBeforeWeekly  Int?    // Minutes before weekly threshold to alert
  notifyEmployee     Boolean @default(true)
  notifyManager      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("overtime_config")
}

// Timeclock rules configuration (singleton - all workflow feature toggles)
model TimeclockRulesConfig {
  id                     String  @id @default(uuid())

  // Auto-approve
  autoApproveEnabled     Boolean @default(false)
  autoApproveMinHours    Float   @default(0.25)  // 15 min minimum
  autoApproveMaxHours    Float   @default(12)
  autoApproveBlockOnOT   Boolean @default(true)

  // Missed punch detection
  missedPunchEnabled         Boolean @default(true)
  missedPunchThresholdHours  Float   @default(12)

  // Time rounding
  roundingMode           String  @default("none") // "none" | "5min" | "6min" | "7min" | "15min"

  // Minimum duration filter
  minDurationEnabled     Boolean @default(false)
  minDurationSeconds     Int     @default(120)
  minDurationAction      String  @default("flag") // "flag" | "reject"

  // Employee attestation
  attestationEnabled     Boolean @default(false)

  // Break deduction
  breakDeductionEnabled  Boolean @default(false)
  breakDeductionMinutes  Int     @default(30)
  breakDeductionAfterHours Float @default(6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("timeclock_rules_config")
}

// Pay period lock (one record per locked period)
model PayPeriodLock {
  id          String   @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  lockedAt    DateTime @default(now())
  lockedBy    String
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([periodStart, periodEnd])
  @@index([isActive])
  @@map("pay_period_locks")
}

// Manager-Department assignments for multi-department oversight
model ManagerAssignment {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
  @@map("manager_assignments")
}

// Export template for custom payroll export formats
model ExportTemplate {
  id        String  @id @default(uuid())
  name      String
  columns   String  // JSON array of column configurations
  isDefault Boolean @default(false)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([isDefault])
  @@map("export_templates")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSettings {
  id                    String   @id @default(uuid())
  key                   String   @unique
  value                 String
  description           String?
  category              String   @default("general") // "general", "file_upload", "security", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("system_settings")
}

// ============================================
// SYSTEM CONFIGURATION (First-run state)
// ============================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ============================================
// AUDIT LOG SYSTEM
// ============================================

model AuditLog {
  id String @id @default(uuid())

  // Who did it
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // What happened
  action     String // "USER_CREATED", "PO_APPROVED", "LOGIN_FAILED", etc.
  entityType String // "User", "PurchaseOrder", "Role", "Department", etc.
  entityId   String? // ID of the affected entity

  // Changes (JSON: { before: {...}, after: {...} })
  changes String @default("{}")

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// RECEIPT MANAGEMENT SYSTEM
// ============================================

// Receipt status enum
enum ReceiptStatus {
  PENDING    // Uploaded, awaiting OCR
  PROCESSING // OCR in progress
  COMPLETED  // OCR complete, data extracted
  FAILED     // OCR failed
  REVIEWED   // User has reviewed/edited
}

// Receipt source enum
enum ReceiptSource {
  UPLOAD     // Manual upload
  EMAIL      // Forwarded via email
  SCAN       // Scanned via mobile app
}

// Receipt model - core expense receipt tracking
model Receipt {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional link to vendor
  vendorId      String?
  vendor        Vendor?       @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  // Optional link to purchase order
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  // Optional link to budget category
  budgetCategoryId String?
  budgetCategory   BudgetCategory? @relation(fields: [budgetCategoryId], references: [id], onDelete: SetNull)

  // Receipt data (extracted via OCR or manual entry)
  merchantName  String?
  receiptDate   DateTime?
  totalAmount   Float?        // Amount in original currency
  currency      String        @default("USD")
  taxAmount     Float?

  // Multi-currency support
  convertedAmount Float?      // Amount in base currency
  conversionRate  Float?      // Rate used for conversion
  targetCurrency  String?     // Currency converted to

  // Status and processing
  status        ReceiptStatus @default(PENDING)

  // File storage
  imageUrl      String?       // Path to receipt image
  thumbnailUrl  String?       // Thumbnail preview

  // OCR data (JSON stored as string)
  rawOcrData    String?       // Raw OCR response for debugging

  // Source tracking
  source        ReceiptSource @default(UPLOAD)
  senderEmail   String?       // Email sender for forwarded receipts
  emailSubject  String?       // Original email subject
  rawEmailHtml  String?       // Original email HTML for reference

  // Notes
  notes         String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  lineItems     ReceiptLineItem[]
  tags          ReceiptTag[]
  bankTransactions BankTransaction[]

  @@index([userId])
  @@index([vendorId])
  @@index([purchaseOrderId])
  @@index([budgetCategoryId])
  @@index([receiptDate])
  @@index([status])
  @@map("receipts")
}

// Receipt line item model
model ReceiptLineItem {
  id          String   @id @default(uuid())
  receiptId   String
  receipt     Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  description String
  quantity    Float?
  unitPrice   Float?
  total       Float

  // Optional category for line item
  budgetCategoryId String?
  budgetCategory   BudgetCategory? @relation(fields: [budgetCategoryId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([receiptId])
  @@index([budgetCategoryId])
  @@map("receipt_line_items")
}

// Tag model for receipt labeling
model Tag {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  color     String   @default("#6B7280") // gray-500

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  receiptTags ReceiptTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

// Receipt-Tag join table (many-to-many)
model ReceiptTag {
  id        String   @id @default(uuid())
  receiptId String
  receipt   Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([receiptId, tagId])
  @@index([receiptId])
  @@index([tagId])
  @@map("receipt_tags")
}

// Merchant-Category mapping for AI learning
model MerchantCategoryMapping {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  merchantName    String   // Normalized merchant name (lowercase, trimmed)
  budgetCategoryId String
  budgetCategory  BudgetCategory @relation(fields: [budgetCategoryId], references: [id], onDelete: Cascade)

  useCount        Int      @default(1) // Number of times this mapping was used

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, merchantName])
  @@index([userId])
  @@index([merchantName])
  @@map("merchant_category_mappings")
}

// ============================================
// AI USAGE TRACKING
// ============================================

model AIUsageLog {
  id                 String   @id @default(uuid())
  userId             String?
  taskType           String   // "ocr" | "categorize" | "summarize"
  provider           String   // "anthropic" | "openai" | "openrouter" | "ollama" | "custom"
  model              String
  inputTokens        Int      @default(0)
  outputTokens       Int      @default(0)
  estimatedCostCents Int      @default(0)
  entityType         String?
  entityId           String?
  durationMs         Int      @default(0)
  success            Boolean  @default(true)
  errorCode          String?
  createdAt          DateTime @default(now())

  @@index([userId])
  @@index([taskType])
  @@index([provider])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

// ============================================
// BANK STATEMENT RECONCILIATION
// ============================================

// Bank statement status enum
enum BankStatementStatus {
  PENDING    // Uploaded, awaiting parsing
  PROCESSING // Parsing in progress
  COMPLETED  // Parsing complete
  FAILED     // Parsing failed
}

// Bank transaction type enum
enum BankTransactionType {
  DEBIT
  CREDIT
}

// Bank statement model
model BankStatement {
  id           String              @id @default(uuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  filename     String              // Original filename
  filePath     String              // Path to file
  uploadDate   DateTime            @default(now())
  startDate    DateTime?           // First transaction date
  endDate      DateTime?           // Last transaction date
  accountName  String?             // Bank account name/identifier

  status       BankStatementStatus @default(PENDING)

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  transactions BankTransaction[]

  @@index([userId])
  @@index([uploadDate])
  @@index([status])
  @@map("bank_statements")
}

// Bank transaction model
model BankTransaction {
  id                  String              @id @default(uuid())
  statementId         String
  statement           BankStatement       @relation(fields: [statementId], references: [id], onDelete: Cascade)

  transactionDate     DateTime
  description         String
  amount              Float
  type                BankTransactionType

  // Matching
  matchedReceiptId    String?
  matchedReceipt      Receipt?            @relation(fields: [matchedReceiptId], references: [id], onDelete: SetNull)

  // Optional link to purchase order
  matchedPurchaseOrderId String?
  matchedPurchaseOrder   PurchaseOrder?   @relation(fields: [matchedPurchaseOrderId], references: [id], onDelete: SetNull)

  noReceiptRequired   Boolean             @default(false) // Mark transactions that don't need receipts

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([statementId])
  @@index([transactionDate])
  @@index([matchedReceiptId])
  @@index([matchedPurchaseOrderId])
  @@map("bank_transactions")
}
