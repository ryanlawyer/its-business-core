# Timeclock Enhancements Progress

## Overview
- Design Doc: docs/plans/2026-02-04-timeclock-enhancements-design.md
- Total Stories: 27
- Phases: 6

## Progress Log

---

## Iteration 1 - TC-001: Pay Period Config Model

### What was implemented
- Added `PayPeriodConfig` model to Prisma schema with:
  - id, type, startDayOfWeek, startDate, timestamps
  - type supports: weekly, biweekly, semimonthly, monthly
- Extended `UserPermissions` type with `canManageConfig` in timeclock section
- Created `/api/timeclock/config` API route with:
  - GET endpoint returning pay period configuration (with singleton auto-creation)
  - PUT endpoint for updating configuration with validation
  - Permission check for `canManageConfig`
  - Audit logging for config changes
- Created `/admin/timeclock` admin UI page with:
  - Pay period type selector (radio buttons with descriptions)
  - Start day of week dropdown (for weekly/biweekly)
  - Reference start date picker (for biweekly)
  - Loading skeleton, error/success alerts
  - Permission-based access control (redirects if unauthorized)

### Key decisions
- Used singleton pattern for PayPeriodConfig (only one config per system)
- Auto-create default config on first GET request
- Start day of week only shown for weekly/biweekly types
- Reference start date only shown for biweekly type

### Files created/modified
- `prisma/schema.prisma` - Added PayPeriodConfig model
- `src/lib/check-permissions.ts` - Added canManageConfig permission
- `src/app/api/timeclock/config/route.ts` - New API route
- `src/app/admin/timeclock/page.tsx` - New admin UI page

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 2 - TC-002: Overtime Config Model

### What was implemented
- Added `OvertimeConfig` model to Prisma schema with:
  - id, dailyThreshold, weeklyThreshold (nullable Int for minutes)
  - alertBeforeDaily, alertBeforeWeekly (nullable Int for minutes)
  - notifyEmployee, notifyManager (Boolean defaults)
  - timestamps
- Extended `/api/timeclock/config` API route:
  - GET now returns both `payPeriodConfig` and `overtimeConfig`
  - PUT handles overtime fields: dailyThreshold, weeklyThreshold, alertBeforeDaily, alertBeforeWeekly, notifyEmployee, notifyManager
  - Singleton auto-creation with sensible defaults (8h daily, 40h weekly)
  - Validation for positive integers or null
  - Separate audit logging for overtime config changes
- Extended `/admin/timeclock` admin UI page with:
  - Tabbed interface (Pay Periods / Overtime Rules)
  - Daily threshold input (in hours, converted to minutes for API)
  - Weekly threshold input (in hours, converted to minutes for API)
  - Alert threshold inputs (in minutes)
  - Employee notification checkbox
  - Manager notification checkbox
  - Helper functions for hours/minutes conversion

### Key decisions
- Used singleton pattern for OvertimeConfig (matches PayPeriodConfig pattern)
- Thresholds stored in minutes but displayed in hours for UX
- Alert thresholds remain in minutes (finer granularity useful)
- Null values disable the respective threshold
- Separate save buttons per tab to avoid accidental overwrites
- Maintained backwards compatibility with `config` field in API response

### Files modified
- `prisma/schema.prisma` - Added OvertimeConfig model
- `src/app/api/timeclock/config/route.ts` - Extended for overtime handling
- `src/app/admin/timeclock/page.tsx` - Added overtime settings tab

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 3 - TC-003: Manager Assignment Model

### What was implemented
- Added `ManagerAssignment` model to Prisma schema with:
  - userId, departmentId with unique constraint
  - Relations to User and Department models
  - Cascade delete on both relations
  - Indexes on userId and departmentId
- Added `canAssignManagers` permission to UserPermissions type
- Created `/api/timeclock/manager-assignments` API route with:
  - GET: List all assignments (with optional userId/departmentId filter)
  - POST: Create new assignment with validation
  - DELETE: Remove assignment by userId and departmentId
  - Permission check for `canAssignManagers`
  - Audit logging for assignment changes
- Created `/admin/timeclock/managers` admin UI page with:
  - Form to add new manager-department assignment
  - User and department dropdowns
  - Grouped view showing managers and their assigned departments
  - Department overview table showing which managers are assigned
  - Remove assignment with confirmation
  - Loading skeleton and error/success alerts

### Key decisions
- Used composite unique constraint on (userId, departmentId)
- Grouped assignments by user in UI for cleaner display
- Included department overview table for quick visibility
- Used chips with X button for easy removal of assignments

### Files created/modified
- `prisma/schema.prisma` - Added ManagerAssignment model and relations
- `src/lib/check-permissions.ts` - Added canAssignManagers permission
- `src/app/api/timeclock/manager-assignments/route.ts` - New API route
- `src/app/admin/timeclock/managers/page.tsx` - New admin UI page

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 4 - TC-004: TimeclockEntry Schema Updates

### What was implemented
- Extended `TimeclockEntry` model in Prisma schema with:
  - `status` field (String, default: "pending") for approval workflow
  - `approvedBy` (String?) for tracking who approved
  - `approvedAt` (DateTime?) for tracking when approved
  - `rejectedNote` (String?) for rejection reason
  - `isLocked` (Boolean, default: false) for preventing edits after approval
  - `lastEditedBy` (String?) for audit trail
  - `lastEditedAt` (DateTime?) for audit trail
  - Index on `status` field for query performance

### Key decisions
- Used String for status instead of enum for flexibility
- Existing entries default to "pending" status (SQLite default behavior)
- approvedBy stores user ID (not a relation) for simplicity
- isLocked defaults to false, set to true when approved

### Files modified
- `prisma/schema.prisma` - Extended TimeclockEntry model with approval and audit fields

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 5 - TC-005: Extended Timeclock Permissions

### What was implemented
- Extended `UserPermissions` type in check-permissions.ts with new timeclock permissions:
  - Manager permissions: canViewTeamEntries, canEditTeamEntries, canApproveEntries, canExportPayroll
  - Admin permissions: canViewAllEntries, canManageConfig, canManageExportTemplates, canAssignManagers
- Updated seed.ts with default role permissions:
  - USER role: canClockInOut and canViewOwnEntries only (all others disabled)
  - MANAGER role: adds canViewTeamEntries, canEditTeamEntries, canApproveEntries, canExportPayroll
  - ADMIN role: all timeclock permissions enabled (_isAdmin flag provides override)

### Key decisions
- Kept existing hasPermission function which already handles permission checking
- canManageConfig and canAssignManagers were already added in previous stories
- Permission checks already work via the hasPermission helper function
- Seed file updated to ensure fresh installs have correct default permissions

### Files modified
- `src/lib/check-permissions.ts` - Extended UserPermissions type with all timeclock permissions
- `prisma/seed.ts` - Updated role permission defaults for timeclock

### Quality checks
- Build passes successfully

---

## Iteration 6 - TC-006: Team Entries API

### What was implemented
- Created `/api/timeclock/team` GET endpoint with:
  - Permission check for canViewTeamEntries or canViewAllEntries
  - Respects ManagerAssignment - only shows assigned departments for managers
  - Admins with canViewAllEntries can see all departments
  - Query params: userId, departmentId, status, periodStart, periodEnd
  - Returns entries with user and department info
  - Calculates employee totals (total/regular/OT minutes, entry counts by status)
  - Returns accessible departments list for filtering
  - Returns 403 if manager has no department assignments

### Key decisions
- Admins bypass department assignment check with canViewAllEntries
- OT minutes placeholder (0) until TC-011 implements overtime calculation
- Returns employeeTotals as aggregated data per employee
- Filters by user's department (the employee's assigned department)

### Files created
- `src/app/api/timeclock/team/route.ts` - New team entries API endpoint

### Quality checks
- Build passes successfully

---

## Iteration 7 - TC-007: Entry Edit API

### What was implemented
- Created `/api/timeclock/[id]` route with:
  - GET: Fetch single entry (own entries or with team/all view permission)
  - PUT: Edit clockIn/clockOut times for managers
- PUT endpoint features:
  - Permission check for canEditTeamEntries
  - Returns 400 if entry is locked (isLocked=true)
  - Recalculates duration in seconds on edit
  - Sets lastEditedBy to current user ID
  - Sets lastEditedAt to current timestamp
  - Department assignment check for managers (not admins)
  - Audit logging with before/after values
  - Returns updated entry with user info

### Key decisions
- Combined GET and PUT in same route file for REST consistency
- Validates clockOut cannot be before clockIn
- Duration set to null if clockOut is cleared
- Admins (canViewAllEntries) bypass department checks

### Files created
- `src/app/api/timeclock/[id]/route.ts` - Entry detail and edit API

### Quality checks
- Build passes successfully

---

## Iteration 8 - TC-008: Approval API

### What was implemented
- Created `/api/timeclock/[id]/approve` POST endpoint:
  - Permission check for canApproveEntries
  - Cannot approve active entries (no clockOut yet)
  - Cannot approve already-approved entries
  - Department assignment check for managers (admins bypass)
  - Sets status='approved', approvedBy, approvedAt, isLocked=true
  - Clears rejectedNote if present
  - Audit logging for approval action
- Created `/api/timeclock/[id]/reject` POST endpoint:
  - Permission check for canApproveEntries
  - Requires rejectedNote in request body (validated)
  - Cannot reject active entries (no clockOut yet)
  - Department assignment check for managers (admins bypass)
  - Sets status='rejected', isLocked=false to allow edits
  - Clears approvedBy/approvedAt
  - Stores rejectedNote for employee visibility
  - Audit logging for rejection action

### Key decisions
- Separate routes for approve and reject for clarity
- Reject requires note to ensure employees understand why
- isLocked=false on rejection allows manager to edit before re-approval
- Approval clears rejection note for clean state
- Both endpoints share similar structure for consistency

### Files created
- `src/app/api/timeclock/[id]/approve/route.ts` - Approval endpoint
- `src/app/api/timeclock/[id]/reject/route.ts` - Rejection endpoint

### Quality checks
- Build passes successfully

---

## Iteration 9 - TC-009: Bulk Approval API

### What was implemented
- Created `/api/timeclock/bulk-approve` POST endpoint:
  - Accepts array of entry IDs in request body
  - Permission check for canApproveEntries
  - Department assignment check for managers (admins bypass)
  - Processes all entries in a single transaction
  - Skips entries that are:
    - Already approved
    - Locked (isLocked=true)
    - Active (no clockOut yet)
  - Fails entries that are:
    - Not found
    - Not in manager's assigned departments
  - Returns detailed results: approved count, skipped count, failed count
  - Returns details array with per-entry status and reasons
  - Audit logging for each approved entry (marked as bulk operation)

### Key decisions
- Used transaction to ensure all-or-nothing semantics
- Categorized skip vs fail: skip for valid business reasons, fail for permission/not found
- Included detailed per-entry results for UI feedback
- Marked audit logs with bulkOperation=true for traceability

### Files created
- `src/app/api/timeclock/bulk-approve/route.ts` - Bulk approval endpoint

### Quality checks
- Build passes successfully

---

## Iteration 10 - TC-010: Pending Approvals API

### What was implemented
- Created `/api/timeclock/pending` GET endpoint:
  - Permission check for canApproveEntries
  - Department assignment check for managers (admins bypass)
  - Returns only pending entries (status='pending')
  - Excludes active entries (no clockOut yet)
  - Query params: departmentId, periodStart, periodEnd
  - Sorted by clockIn ascending (oldest first)
  - Returns totalCount of pending entries
  - Returns accessible departments list for filter dropdown
  - Includes employee name and department with each entry

### Key decisions
- Returns departments list for UI filter dropdown
- Period filters use clockIn date for consistency
- Admins see all departments, managers see only assigned
- Specific department filter validates access before query

### Files created
- `src/app/api/timeclock/pending/route.ts` - Pending approvals endpoint

### Quality checks
- Build passes successfully

---

## Iteration 11 - TC-011: Overtime Calculation Service

### What was implemented
- Created `src/lib/overtime.ts` with:
  - `calculateOvertime()` function accepting entries and OvertimeConfig
  - Calculates regularMinutes, dailyOvertimeMinutes, weeklyOvertimeMinutes
  - Daily OT: hours exceeding daily threshold per day
  - Weekly OT: hours exceeding weekly threshold (after daily OT subtracted)
  - Handles null thresholds (disabled) - returns all time as regular
  - Returns EmployeeOvertimeResult per employee with breakdown
  - Returns OvertimeCalculationResult with totals across all employees
  - Helper functions: calculateDailyMinutes, calculateWeeklyMinutes
- Set up vitest testing framework:
  - Added vitest as dev dependency
  - Created vitest.config.ts with path aliases
  - Added test and test:watch scripts
- Created comprehensive test suite with 18 tests covering:
  - Null config handling
  - Both thresholds disabled
  - Daily overtime calculation
  - Weekly overtime calculation
  - Combined daily and weekly overtime
  - Multiple employees
  - Edge cases (empty array, missing clockOut, missing duration)

### Key decisions
- Weekly OT calculated from "daily regular" after daily OT removed
- Thresholds stored in minutes for precision
- Week starts on Sunday (standard US payroll)
- Entries without clockOut or duration are skipped

### Files created
- `src/lib/overtime.ts` - Overtime calculation service
- `src/lib/__tests__/overtime.test.ts` - Unit tests (18 tests)
- `vitest.config.ts` - Test configuration

### Files modified
- `package.json` - Added vitest dependency and test scripts

### Quality checks
- Build passes successfully
- All 18 tests pass
