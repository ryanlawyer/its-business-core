# Timeclock Enhancements Progress

## Overview
- Design Doc: docs/plans/2026-02-04-timeclock-enhancements-design.md
- Total Stories: 27
- Phases: 6

## Progress Log

---

## Iteration 1 - TC-001: Pay Period Config Model

### What was implemented
- Added `PayPeriodConfig` model to Prisma schema with:
  - id, type, startDayOfWeek, startDate, timestamps
  - type supports: weekly, biweekly, semimonthly, monthly
- Extended `UserPermissions` type with `canManageConfig` in timeclock section
- Created `/api/timeclock/config` API route with:
  - GET endpoint returning pay period configuration (with singleton auto-creation)
  - PUT endpoint for updating configuration with validation
  - Permission check for `canManageConfig`
  - Audit logging for config changes
- Created `/admin/timeclock` admin UI page with:
  - Pay period type selector (radio buttons with descriptions)
  - Start day of week dropdown (for weekly/biweekly)
  - Reference start date picker (for biweekly)
  - Loading skeleton, error/success alerts
  - Permission-based access control (redirects if unauthorized)

### Key decisions
- Used singleton pattern for PayPeriodConfig (only one config per system)
- Auto-create default config on first GET request
- Start day of week only shown for weekly/biweekly types
- Reference start date only shown for biweekly type

### Files created/modified
- `prisma/schema.prisma` - Added PayPeriodConfig model
- `src/lib/check-permissions.ts` - Added canManageConfig permission
- `src/app/api/timeclock/config/route.ts` - New API route
- `src/app/admin/timeclock/page.tsx` - New admin UI page

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 2 - TC-002: Overtime Config Model

### What was implemented
- Added `OvertimeConfig` model to Prisma schema with:
  - id, dailyThreshold, weeklyThreshold (nullable Int for minutes)
  - alertBeforeDaily, alertBeforeWeekly (nullable Int for minutes)
  - notifyEmployee, notifyManager (Boolean defaults)
  - timestamps
- Extended `/api/timeclock/config` API route:
  - GET now returns both `payPeriodConfig` and `overtimeConfig`
  - PUT handles overtime fields: dailyThreshold, weeklyThreshold, alertBeforeDaily, alertBeforeWeekly, notifyEmployee, notifyManager
  - Singleton auto-creation with sensible defaults (8h daily, 40h weekly)
  - Validation for positive integers or null
  - Separate audit logging for overtime config changes
- Extended `/admin/timeclock` admin UI page with:
  - Tabbed interface (Pay Periods / Overtime Rules)
  - Daily threshold input (in hours, converted to minutes for API)
  - Weekly threshold input (in hours, converted to minutes for API)
  - Alert threshold inputs (in minutes)
  - Employee notification checkbox
  - Manager notification checkbox
  - Helper functions for hours/minutes conversion

### Key decisions
- Used singleton pattern for OvertimeConfig (matches PayPeriodConfig pattern)
- Thresholds stored in minutes but displayed in hours for UX
- Alert thresholds remain in minutes (finer granularity useful)
- Null values disable the respective threshold
- Separate save buttons per tab to avoid accidental overwrites
- Maintained backwards compatibility with `config` field in API response

### Files modified
- `prisma/schema.prisma` - Added OvertimeConfig model
- `src/app/api/timeclock/config/route.ts` - Extended for overtime handling
- `src/app/admin/timeclock/page.tsx` - Added overtime settings tab

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 3 - TC-003: Manager Assignment Model

### What was implemented
- Added `ManagerAssignment` model to Prisma schema with:
  - userId, departmentId with unique constraint
  - Relations to User and Department models
  - Cascade delete on both relations
  - Indexes on userId and departmentId
- Added `canAssignManagers` permission to UserPermissions type
- Created `/api/timeclock/manager-assignments` API route with:
  - GET: List all assignments (with optional userId/departmentId filter)
  - POST: Create new assignment with validation
  - DELETE: Remove assignment by userId and departmentId
  - Permission check for `canAssignManagers`
  - Audit logging for assignment changes
- Created `/admin/timeclock/managers` admin UI page with:
  - Form to add new manager-department assignment
  - User and department dropdowns
  - Grouped view showing managers and their assigned departments
  - Department overview table showing which managers are assigned
  - Remove assignment with confirmation
  - Loading skeleton and error/success alerts

### Key decisions
- Used composite unique constraint on (userId, departmentId)
- Grouped assignments by user in UI for cleaner display
- Included department overview table for quick visibility
- Used chips with X button for easy removal of assignments

### Files created/modified
- `prisma/schema.prisma` - Added ManagerAssignment model and relations
- `src/lib/check-permissions.ts` - Added canAssignManagers permission
- `src/app/api/timeclock/manager-assignments/route.ts` - New API route
- `src/app/admin/timeclock/managers/page.tsx` - New admin UI page

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 4 - TC-004: TimeclockEntry Schema Updates

### What was implemented
- Extended `TimeclockEntry` model in Prisma schema with:
  - `status` field (String, default: "pending") for approval workflow
  - `approvedBy` (String?) for tracking who approved
  - `approvedAt` (DateTime?) for tracking when approved
  - `rejectedNote` (String?) for rejection reason
  - `isLocked` (Boolean, default: false) for preventing edits after approval
  - `lastEditedBy` (String?) for audit trail
  - `lastEditedAt` (DateTime?) for audit trail
  - Index on `status` field for query performance

### Key decisions
- Used String for status instead of enum for flexibility
- Existing entries default to "pending" status (SQLite default behavior)
- approvedBy stores user ID (not a relation) for simplicity
- isLocked defaults to false, set to true when approved

### Files modified
- `prisma/schema.prisma` - Extended TimeclockEntry model with approval and audit fields

### Quality checks
- Build passes successfully
- Database migration applied without errors

---

## Iteration 5 - TC-005: Extended Timeclock Permissions

### What was implemented
- Extended `UserPermissions` type in check-permissions.ts with new timeclock permissions:
  - Manager permissions: canViewTeamEntries, canEditTeamEntries, canApproveEntries, canExportPayroll
  - Admin permissions: canViewAllEntries, canManageConfig, canManageExportTemplates, canAssignManagers
- Updated seed.ts with default role permissions:
  - USER role: canClockInOut and canViewOwnEntries only (all others disabled)
  - MANAGER role: adds canViewTeamEntries, canEditTeamEntries, canApproveEntries, canExportPayroll
  - ADMIN role: all timeclock permissions enabled (_isAdmin flag provides override)

### Key decisions
- Kept existing hasPermission function which already handles permission checking
- canManageConfig and canAssignManagers were already added in previous stories
- Permission checks already work via the hasPermission helper function
- Seed file updated to ensure fresh installs have correct default permissions

### Files modified
- `src/lib/check-permissions.ts` - Extended UserPermissions type with all timeclock permissions
- `prisma/seed.ts` - Updated role permission defaults for timeclock

### Quality checks
- Build passes successfully

---

## Iteration 6 - TC-006: Team Entries API

### What was implemented
- Created `/api/timeclock/team` GET endpoint with:
  - Permission check for canViewTeamEntries or canViewAllEntries
  - Respects ManagerAssignment - only shows assigned departments for managers
  - Admins with canViewAllEntries can see all departments
  - Query params: userId, departmentId, status, periodStart, periodEnd
  - Returns entries with user and department info
  - Calculates employee totals (total/regular/OT minutes, entry counts by status)
  - Returns accessible departments list for filtering
  - Returns 403 if manager has no department assignments

### Key decisions
- Admins bypass department assignment check with canViewAllEntries
- OT minutes placeholder (0) until TC-011 implements overtime calculation
- Returns employeeTotals as aggregated data per employee
- Filters by user's department (the employee's assigned department)

### Files created
- `src/app/api/timeclock/team/route.ts` - New team entries API endpoint

### Quality checks
- Build passes successfully

---

## Iteration 7 - TC-007: Entry Edit API

### What was implemented
- Created `/api/timeclock/[id]` route with:
  - GET: Fetch single entry (own entries or with team/all view permission)
  - PUT: Edit clockIn/clockOut times for managers
- PUT endpoint features:
  - Permission check for canEditTeamEntries
  - Returns 400 if entry is locked (isLocked=true)
  - Recalculates duration in seconds on edit
  - Sets lastEditedBy to current user ID
  - Sets lastEditedAt to current timestamp
  - Department assignment check for managers (not admins)
  - Audit logging with before/after values
  - Returns updated entry with user info

### Key decisions
- Combined GET and PUT in same route file for REST consistency
- Validates clockOut cannot be before clockIn
- Duration set to null if clockOut is cleared
- Admins (canViewAllEntries) bypass department checks

### Files created
- `src/app/api/timeclock/[id]/route.ts` - Entry detail and edit API

### Quality checks
- Build passes successfully

---

## Iteration 8 - TC-008: Approval API

### What was implemented
- Created `/api/timeclock/[id]/approve` POST endpoint:
  - Permission check for canApproveEntries
  - Cannot approve active entries (no clockOut yet)
  - Cannot approve already-approved entries
  - Department assignment check for managers (admins bypass)
  - Sets status='approved', approvedBy, approvedAt, isLocked=true
  - Clears rejectedNote if present
  - Audit logging for approval action
- Created `/api/timeclock/[id]/reject` POST endpoint:
  - Permission check for canApproveEntries
  - Requires rejectedNote in request body (validated)
  - Cannot reject active entries (no clockOut yet)
  - Department assignment check for managers (admins bypass)
  - Sets status='rejected', isLocked=false to allow edits
  - Clears approvedBy/approvedAt
  - Stores rejectedNote for employee visibility
  - Audit logging for rejection action

### Key decisions
- Separate routes for approve and reject for clarity
- Reject requires note to ensure employees understand why
- isLocked=false on rejection allows manager to edit before re-approval
- Approval clears rejection note for clean state
- Both endpoints share similar structure for consistency

### Files created
- `src/app/api/timeclock/[id]/approve/route.ts` - Approval endpoint
- `src/app/api/timeclock/[id]/reject/route.ts` - Rejection endpoint

### Quality checks
- Build passes successfully

---

## Iteration 9 - TC-009: Bulk Approval API

### What was implemented
- Created `/api/timeclock/bulk-approve` POST endpoint:
  - Accepts array of entry IDs in request body
  - Permission check for canApproveEntries
  - Department assignment check for managers (admins bypass)
  - Processes all entries in a single transaction
  - Skips entries that are:
    - Already approved
    - Locked (isLocked=true)
    - Active (no clockOut yet)
  - Fails entries that are:
    - Not found
    - Not in manager's assigned departments
  - Returns detailed results: approved count, skipped count, failed count
  - Returns details array with per-entry status and reasons
  - Audit logging for each approved entry (marked as bulk operation)

### Key decisions
- Used transaction to ensure all-or-nothing semantics
- Categorized skip vs fail: skip for valid business reasons, fail for permission/not found
- Included detailed per-entry results for UI feedback
- Marked audit logs with bulkOperation=true for traceability

### Files created
- `src/app/api/timeclock/bulk-approve/route.ts` - Bulk approval endpoint

### Quality checks
- Build passes successfully

---

## Iteration 10 - TC-010: Pending Approvals API

### What was implemented
- Created `/api/timeclock/pending` GET endpoint:
  - Permission check for canApproveEntries
  - Department assignment check for managers (admins bypass)
  - Returns only pending entries (status='pending')
  - Excludes active entries (no clockOut yet)
  - Query params: departmentId, periodStart, periodEnd
  - Sorted by clockIn ascending (oldest first)
  - Returns totalCount of pending entries
  - Returns accessible departments list for filter dropdown
  - Includes employee name and department with each entry

### Key decisions
- Returns departments list for UI filter dropdown
- Period filters use clockIn date for consistency
- Admins see all departments, managers see only assigned
- Specific department filter validates access before query

### Files created
- `src/app/api/timeclock/pending/route.ts` - Pending approvals endpoint

### Quality checks
- Build passes successfully

---

## Iteration 11 - TC-011: Overtime Calculation Service

### What was implemented
- Created `src/lib/overtime.ts` with:
  - `calculateOvertime()` function accepting entries and OvertimeConfig
  - Calculates regularMinutes, dailyOvertimeMinutes, weeklyOvertimeMinutes
  - Daily OT: hours exceeding daily threshold per day
  - Weekly OT: hours exceeding weekly threshold (after daily OT subtracted)
  - Handles null thresholds (disabled) - returns all time as regular
  - Returns EmployeeOvertimeResult per employee with breakdown
  - Returns OvertimeCalculationResult with totals across all employees
  - Helper functions: calculateDailyMinutes, calculateWeeklyMinutes
- Set up vitest testing framework:
  - Added vitest as dev dependency
  - Created vitest.config.ts with path aliases
  - Added test and test:watch scripts
- Created comprehensive test suite with 18 tests covering:
  - Null config handling
  - Both thresholds disabled
  - Daily overtime calculation
  - Weekly overtime calculation
  - Combined daily and weekly overtime
  - Multiple employees
  - Edge cases (empty array, missing clockOut, missing duration)

### Key decisions
- Weekly OT calculated from "daily regular" after daily OT removed
- Thresholds stored in minutes for precision
- Week starts on Sunday (standard US payroll)
- Entries without clockOut or duration are skipped

### Files created
- `src/lib/overtime.ts` - Overtime calculation service
- `src/lib/__tests__/overtime.test.ts` - Unit tests (18 tests)
- `vitest.config.ts` - Test configuration

### Files modified
- `package.json` - Added vitest dependency and test scripts

### Quality checks
- Build passes successfully
- All 18 tests pass

---

## Iteration 12 - TC-012: Alert Threshold Checking

### What was implemented
- Added `checkAlertStatus()` function to `src/lib/overtime.ts`:
  - Checks current day total against daily threshold
  - Checks current week total against weekly threshold
  - Returns AlertStatus object with daily/weekly sections
  - Each section contains: currentMinutes, thresholdMinutes, approaching, exceeded
  - `approaching` = within alertBefore minutes of threshold
  - `exceeded` = at or over threshold
  - Uses alertBeforeDaily/alertBeforeWeekly config for approaching calculation
  - Accepts optional activeMinutes for in-progress clock-in
  - Returns null if both thresholds disabled or no config
- Added 13 new tests for checkAlertStatus covering:
  - Null config handling
  - Both thresholds disabled
  - Daily alert states (under/approaching/exceeded)
  - Weekly alert states (under/approaching/exceeded)
  - Active minutes inclusion
  - Combined daily and weekly alerts
  - Edge cases (no alert window, empty entries)

### Key decisions
- activeMinutes parameter allows real-time updates for in-progress sessions
- approaching is only true if NOT exceeded (mutually exclusive states)
- When alertBefore is null, approaching is always false
- Returns both daily and weekly status in single call for efficiency

### Files modified
- `src/lib/overtime.ts` - Added checkAlertStatus function and AlertStatus interface
- `src/lib/__tests__/overtime.test.ts` - Added 13 new tests (now 31 total)

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 13 - TC-013: Employee Alert Banner

### What was implemented
- Created `/api/timeclock/alerts` GET endpoint:
  - Returns current alert status for authenticated user
  - Checks notifyEmployee config flag before returning data
  - Fetches user's entries for current week
  - Calculates active session minutes for real-time updates
  - Uses checkAlertStatus function from overtime service
  - Returns null alertStatus if notifications disabled
- Created `OvertimeAlertBanner` React component:
  - Fetches alert status from API on mount
  - Displays yellow warning banner when approaching thresholds
  - Displays red warning banner when exceeding thresholds
  - Shows current hours vs threshold (e.g., "Today: 7h 30m of 8h")
  - Separate banners for daily and weekly alerts
  - Dismissable with X button (state resets on page refresh)
  - Auto-refreshes every 30 seconds
  - Accepts onUpdate prop to trigger manual refresh
- Integrated banner into main timeclock page:
  - Added OvertimeAlertBanner after department widget
  - Refresh alerts after clock-in/out without page refresh
  - Uses key prop to force re-render on clock events

### Key decisions
- Separate API endpoint for alerts to allow independent fetching
- Component handles its own refresh interval (30 seconds)
- Dismissed state is local only, reappears on page refresh per requirements
- Daily and weekly alerts shown separately for clarity
- Yellow/red color distinction for approaching/exceeded states

### Files created
- `src/app/api/timeclock/alerts/route.ts` - Alert status API endpoint
- `src/components/OvertimeAlertBanner.tsx` - Alert banner component

### Files modified
- `src/app/page.tsx` - Added OvertimeAlertBanner and refresh logic

### Quality checks
- Build passes successfully

---

## Iteration 14 - TC-014: Manager OT Flags

### What was implemented
- Updated `/api/timeclock/team` endpoint to include OT calculations:
  - Integrates with calculateOvertime service
  - Returns otFlags on each entry: exceedsDailyThreshold, hasEmployeeOvertime,
    dailyOvertimeMinutes, weeklyOvertimeMinutes
  - Employee totals now include actual regularMinutes and overtimeMinutes
  - Added hasOvertime, dailyOvertimeMinutes, weeklyOvertimeMinutes to employee totals
  - Returns overtimeConfig for threshold display
  - Flags based on all completed entries (approved and pending)
- Created OvertimeIndicator component:
  - Warning icon with tooltip showing OT amounts
  - Yellow for daily OT, red for weekly OT
  - Configurable size (sm, md, lg)
  - Hover tooltip with breakdown
- Created OvertimeBadge component:
  - Badge showing "OT: Xh Ym" with variant styling
  - Variants: default, daily, weekly
  - Yellow for daily, red for weekly

### Key decisions
- OT flags calculated on every API call for real-time accuracy
- Both approved and pending entries contribute to OT calculation
- Individual entries flagged if they alone exceed daily threshold
- Employee-level flag if any OT across the period
- Color distinction: yellow for daily OT, red for weekly OT

### Files created
- `src/components/OvertimeIndicator.tsx` - OT indicator icon and badge components

### Files modified
- `src/app/api/timeclock/team/route.ts` - Added OT calculation integration

### Quality checks
- Build passes successfully

---

## Iteration 15 - TC-015: Enhanced Employee Dashboard

### What was implemented
- Created `src/lib/pay-period.ts` pay period utility:
  - getCurrentPayPeriod() - calculates current period based on config
  - getPayPeriodForDate() - calculates period for any date
  - getRecentPeriods() - returns last N periods for dropdown
  - Supports weekly, biweekly, semimonthly, monthly period types
  - Handles week start day configuration
  - Biweekly uses reference start date for alignment
- Enhanced `/api/timeclock` GET endpoint:
  - Returns currentPeriod and availablePeriods for period selector
  - Accepts periodStart/periodEnd query params for period filtering
  - Calculates periodStats: regularMinutes, dailyOvertimeMinutes, weeklyOvertimeMinutes
  - Calculates todayStats: totalSeconds, sessionsCompleted
  - Integrates with calculateOvertime service
  - Returns status counts: pendingCount, approvedCount, rejectedCount
  - Returns overtimeConfig for display
- Enhanced main timeclock page (page.tsx):
  - Period selector dropdown showing current pay period dates
  - Period stats card row: Sessions, Pending, Approved, Rejected
  - Today's totals prominently displayed with active session tracking
  - Period regular hours and overtime hours in stat cards
  - Status badges on entries: pending (yellow), approved (green), rejected (red)
  - Lock icon on approved entries (inline and in status badge)
  - Loading skeleton while fetching data (improved with proper layout)
  - Rejection notes displayed inline with rejected entries

### Key decisions
- Period selector shows last 6 periods by default
- Stats cards show period totals, not today-only totals
- Today's total shown separately and prominently
- Rejection notes displayed inline for visibility
- Lock icon shown both in badge and as separate indicator
- Loading skeleton matches final layout structure

### Files created
- `src/lib/pay-period.ts` - Pay period calculation utility

### Files modified
- `src/app/api/timeclock/route.ts` - Enhanced with period data and stats
- `src/app/page.tsx` - Redesigned with period selector and status badges

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 16 - TC-016: Rejection Notice Display

### What was implemented
- Added prominent rejection banner when period has rejected entries:
  - Red warning banner at top of main content area
  - Shows count of rejected entries
  - Clear message: "Please contact your manager for correction"
  - Explains rejected entries are highlighted in red below
  - States employees cannot edit rejected entries directly
- Enhanced rejection notice on individual entries:
  - Styled rejection note box with red border
  - Shows rejection reason from manager
  - "Contact your manager for correction" message inline
  - Dismissable X button per entry (state stored locally)
  - Dismissed notices reappear on page refresh
- Rejected entries remain highlighted in red background
- Employee cannot edit rejected entries (enforced by API isLocked)

### Key decisions
- Used period-level banner for high visibility of rejections
- Individual entry notices are dismissable to reduce clutter
- Dismissal state is local only (reappears on refresh per requirements)
- Clear guidance to contact manager since employees cannot edit

### Files modified
- `src/app/page.tsx` - Added rejection banner and enhanced rejection notices

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 17 - TC-017: Employee History Page

### What was implemented
- Created `/api/timeclock/history` API endpoint:
  - GET endpoint for paginated timeclock history
  - Supports preset filters: this_week, last_week, this_month, last_month, this_year
  - Supports status filter: all, pending, approved, rejected
  - Supports custom dateFrom/dateTo date ranges
  - Returns pagination info: page, limit, totalCount, totalPages, hasNextPage, hasPrevPage
  - Returns summary: totalMinutes, statusCounts (pending, approved, rejected)
  - Permission check: requires canViewOwnEntries
- Created `/api/timeclock/history/export` API endpoint:
  - GET endpoint for CSV export
  - Same filter parameters as history endpoint
  - Generates CSV with: Date, Clock In, Clock Out, Duration (h:mm), Status, Rejection Note
  - Proper CSV escaping for commas and quotes
  - Returns file with Content-Disposition header
  - Permission check: requires canViewOwnEntries
- Created `/timeclock/history` page:
  - Date range filter with preset dropdown (All Time, This Week, Last Week, This Month, Last Month, This Year)
  - Status filter dropdown (All Statuses, Pending, Approved, Rejected)
  - Export CSV button (disabled when no entries)
  - Summary stats cards: Total Time, Pending count, Approved count, Rejected count
  - Paginated table showing: Date, Clock In, Clock Out, Duration, Status
  - Status badges with lock icon for approved entries
  - Rejection notes displayed inline for rejected entries
  - Rejected entries highlighted with red background
  - Loading skeleton while fetching
  - Empty state when no entries match filters
  - Pagination controls with Previous/Next buttons

### Key decisions
- Preset filter takes priority over custom date range (no custom date inputs in UI)
- History page is at /timeclock/history (not under /dashboard for timeclock-focused app)
- Back button navigates to main timeclock page (/)
- Export respects current filters
- Pagination uses 20 items per page

### Files created
- `src/app/api/timeclock/history/route.ts` - History API endpoint
- `src/app/api/timeclock/history/export/route.ts` - CSV export endpoint
- `src/app/timeclock/history/page.tsx` - History page UI

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 18 - TC-018: Team Overview Page

### What was implemented
- Created `/timeclock/team` page for managers to view team time summary:
  - Pay period selector dropdown matching pay period config
  - Department filter dropdown (shows only assigned departments for managers)
  - Summary stats cards: Total Employees, Approved, Pending, Rejected counts
  - Employee list table with columns: Employee, Department, Regular Hours, OT Hours, Status
  - Employee rows show name, email, OT badge if employee has overtime
  - Status column shows badges for approved/pending/rejected counts per employee
  - Click employee row to navigate to detail page (/timeclock/team/[userId])
  - "Approve All Pending" button for quick bulk approval
  - Pending Approvals button with badge count links to /timeclock/approvals
  - Back button navigates to main timeclock page
  - Loading skeleton while fetching data
  - Empty state when no employees have entries for the period
- Permission check: redirects to / if user lacks canViewTeamEntries permission
- Uses existing /api/timeclock/team endpoint for data
- Uses existing /api/timeclock/bulk-approve endpoint for bulk approval

### Key decisions
- Reuses existing team API which already calculates OT breakdown per employee
- Period selector uses same availablePeriods from main timeclock API
- Bulk approve targets only pending entries with clockOut (completed entries)
- Employee click navigates to detail page (TC-019 will implement it)
- OT badge shown inline with employee name for visibility

### Files created
- `src/app/timeclock/team/page.tsx` - Team overview page

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 19 - TC-019: Employee Detail Page

### What was implemented
- Created `/timeclock/team/[userId]` page for managers to view and manage individual employee entries:
  - Back button to team overview (/timeclock/team)
  - Period selector matching pay period config
  - Period totals for this employee: Regular, Overtime, Total hours
  - Entry list with checkboxes for selection (only selectable if not locked and has clockOut)
  - Inline edit: click edit button to expand edit form below entry
  - Edit form shows clockIn and clockOut datetime-local inputs
  - Save changes calls PUT /api/timeclock/[id] with audit trail
  - Approve Selected button for bulk approval of selected entries
  - Reject Selected button opens modal for rejection note
  - Reject modal requires reason text, submits to POST /api/timeclock/[id]/reject
  - Locked entries show lock icon, checkbox disabled, cannot be edited
  - Status badges with rejection notes shown inline
  - Rejected entries highlighted with red background
  - Select all checkbox for convenience
- Permission check: redirects to /timeclock/team if user lacks access

### Key decisions
- Only entries with clockOut can be selected/approved/rejected (no active entries)
- Edit form appears as new row below the entry being edited
- Rejection requires modal to force entering a reason
- Bulk reject applies same note to all selected entries
- Uses existing API endpoints for all operations

### Files created
- `src/app/timeclock/team/[userId]/page.tsx` - Employee detail page

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 20 - TC-020: Pending Approvals Page

### What was implemented
- Created `/timeclock/approvals` page for managers to review pending entries:
  - Pending count shown in page header title with badge
  - Period filter matching pay period config
  - Department filter (shows only assigned departments)
  - View mode toggle: Grouped by employee or Flat list
  - Grouped view shows entries nested under each employee with checkboxes
  - Flat view shows all entries in a table with checkboxes
  - Select all checkbox in header
  - Bulk selection by clicking employee checkbox (selects all their entries)
  - Approve Selected button with loading state
  - Reject Selected button opens modal for rejection note
  - Empty state: "All caught up!" when no pending entries
- Permission check: redirects to / if user lacks canApproveEntries
- Uses existing /api/timeclock/pending endpoint

### Key decisions
- View mode defaults to grouped for better organization
- Indeterminate checkbox state when some but not all employee entries selected
- Same rejection modal pattern as employee detail page
- Back button goes to team overview, not main timeclock

### Files created
- `src/app/timeclock/approvals/page.tsx` - Pending approvals page

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 21 - TC-021: Navbar Updates

### What was implemented
- Updated Navbar component with Timeclock dropdown menu:
  - Replaced single Timeclock link with dropdown
  - My Time link (/) - shown to all users
  - My History link (/timeclock/history) - shown to all users
  - Separator divider line between user and manager items
  - Team Overview link (/timeclock/team) - shown if canViewTeamEntries
  - Approvals link (/timeclock/approvals) with pending count badge - shown if canApproveEntries
  - Export link (/timeclock/export) - shown if canExportPayroll
  - Menu items dynamically hide based on permissions
- Added pending count badge that fetches from /api/timeclock/pending
- Pending count refreshes every 60 seconds
- Updated mobile menu with same timeclock items
- Added nav-dropdown-divider CSS class for separator styling

### Key decisions
- Pending count fetched on navbar mount and refreshed periodically
- Manager items only shown when at least one manager permission is present
- Same icon for timeclock dropdown as before (clock icon)
- Export link points to /timeclock/export (TC-027 will implement the page)

### Files modified
- `src/components/Navbar.tsx` - Updated with timeclock dropdown menu
- `src/app/globals.css` - Added nav-dropdown-divider style

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 22 - TC-022: Export Template Model

### What was implemented
- Added `ExportTemplate` model to Prisma schema with:
  - id, name, columns (JSON string), isDefault, createdById, createdAt, updatedAt
  - Relation to User model for createdBy tracking
  - Indexes on createdById and isDefault for query performance
- Created CRUD API at `/api/timeclock/templates`:
  - GET - List all templates with parsed columns, returns availableFields list
  - POST - Create new template with column validation
  - Validates columns against AVAILABLE_EXPORT_FIELDS
  - When setting isDefault=true, automatically unsets other defaults
  - Audit logging for all operations
  - Permission check: canManageExportTemplates for create/update/delete
  - Permission check: canExportPayroll allows read-only access
- Created `/api/timeclock/templates/[id]` for individual template operations:
  - GET - Fetch single template by ID
  - PUT - Update template name, columns, or isDefault
  - DELETE - Remove template with audit log
- Defined AVAILABLE_EXPORT_FIELDS constant with 14 exportable fields:
  - employeeId, employeeName, employeeEmail, department
  - clockIn, clockOut, date
  - regularHours, dailyOvertimeHours, weeklyOvertimeHours, totalHours
  - status, approvedBy, approvedAt

### Key decisions
- Columns stored as JSON string in SQLite (parsed on read, stringified on write)
- Only one template can be marked as default at a time
- Users with canExportPayroll can view templates but not modify them
- Template columns include order field for drag-drop reordering (TC-023)

### Files created/modified
- `prisma/schema.prisma` - Added ExportTemplate model with User relation
- `src/app/api/timeclock/templates/route.ts` - GET/POST endpoints
- `src/app/api/timeclock/templates/[id]/route.ts` - GET/PUT/DELETE endpoints

### Quality checks
- Database migration applied successfully
- Build passes successfully
- All 31 tests pass

---

## Iteration 23 - TC-023: Template Editor UI

### What was implemented
- Created `/admin/timeclock/templates` page for managing export templates:
  - List view showing all templates with name, column count, default status, creator
  - Edit and Delete buttons for each template
  - Create Template button opens editor form
- Template editor form with:
  - Template name input field
  - Set as default checkbox
  - Column mapper section with add/remove column functionality
  - Source field dropdown populated from AVAILABLE_EXPORT_FIELDS
  - Custom header name input for each column
  - Drag-and-drop reordering of columns (native HTML5 drag/drop)
  - Drag handle icon on each column row
  - Auto-update header name when source field changes
- Preview section showing table header with configured column names
- Save and Cancel buttons with loading states
- Permission check: redirects to / if user lacks canManageExportTemplates
- Error and success alert messages

### Key decisions
- Used native HTML5 drag/drop API for column reordering
- Auto-populate header name from field label when source field changes
- Show field name in preview row to indicate data mapping
- Delete confirmation dialog before removing template
- Empty state with prompt to create first template

### Files created
- `src/app/admin/timeclock/templates/page.tsx` - Template editor page

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 24 - TC-024: CSV Export

### What was implemented
- Created `/api/timeclock/export` endpoint for exporting timeclock data:
  - GET /api/timeclock/export?format=csv with query params
  - Query params: periodStart, periodEnd, departmentId, templateId
  - Uses template columns if templateId specified, otherwise default template
  - Falls back to DEFAULT_COLUMNS if no template found
  - Only includes approved entries with completed clockOut
  - Calculates regular/OT hours per employee using overtime.ts
  - Proper CSV escaping for commas, quotes, and newlines
  - Returns file with Content-Disposition attachment header
  - Permission check: requires canExportPayroll
- CSV export aggregates by employee (one row per employee):
  - Employee ID, Name, Email, Department
  - Regular Hours, Daily OT Hours, Weekly OT Hours, Total Hours
  - All hours formatted to 2 decimal places
- Default columns defined for when no template specified

### Key decisions
- Export aggregates by employee rather than per-entry
- Uses overtime calculation service for accurate hour breakdown
- Department filter accepts 'all' or specific departmentId
- Filename includes period dates for easy identification

### Files created
- `src/app/api/timeclock/export/route.ts` - Export API endpoint

### Quality checks
- Build passes successfully
- All 31 tests pass

---

## Iteration 25 - TC-025: Excel Export

### What was implemented
- Extended `/api/timeclock/export` to support format=xlsx:
  - Uses xlsx library for Excel generation
  - Same query params as CSV export (periodStart, periodEnd, departmentId, templateId)
  - Bold header row with gray background fill
  - Auto-width columns based on content (capped at 50 chars)
  - Number formatting for hour columns (0.00 format, 2 decimal places)
  - Proper MIME type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  - Content-Disposition header with .xlsx filename
- Converts hour string values to numbers for proper Excel formatting
- Creates workbook with single "Timeclock Export" sheet

### Key decisions
- Hour columns automatically converted to numbers for Excel math
- Column widths auto-calculated from header and data lengths
- Header styling uses bold font and light gray background
- Same data structure as CSV for consistency

### Files modified
- `src/app/api/timeclock/export/route.ts` - Added xlsx format support

### Quality checks
- Build passes successfully
- All 31 tests pass
